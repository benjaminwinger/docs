<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="University of Waterloo Aerial Robotics Group">
  <link rel="shortcut icon" href="../../favicon.ico">
  
  <title>Datalink - WARG Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Datalink";
    var mkdocs_page_input_path = "picpilot/datalink.md";
    var mkdocs_page_url = "/picpilot/datalink/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68186801-2', 'docs.uwarg.com');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> WARG Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Bootcamps</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../bootcamp/mechanical/">Mechanical</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/computer-vision/">Computer Vision</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/electrical/">Electrical</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/groundstation/">Groundstation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/embedded/">Embedded Software</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/rccompetition/">RC Car Competition</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tutorials</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../tutorials/git/">Git and Github</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tutorials/shell/">Using the terminal</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Groundstation</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../groundstation/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/introduction/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/what-you-need-to-know/">What you need to know</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/installation/">Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/tutorial/">Tutorial</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/project-structure/">Project Structure</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/contributing/">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/documenting/">Documenting</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/resources/">Additional Resources</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">ZeroPilot</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../zeropilot/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../zeropilot/pinout_reference/">Pinout Reference</a>
                </li>
                <li class="">
                    
    <a class="" href="../../zeropilot/hardware/">Hardware</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Network</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../network/data_relay/">Data Relay</a>
                </li>
                <li class="">
                    
    <a class="" href="../../network/multi_echo/">Multi Echo</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Computer Vision</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../computer-vision/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Installation/">Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Building-the-project-[Linux]/">Building the project [Linux]</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Building-the-project-[Windows]/">Building the project [Windows]</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Coding-Conventions/">Coding Conventions</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Contributing/">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Using-the-WARG-server-environment/">Using the WARG computer environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Writing-Tests/">Writing Tests</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Mechanical</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../mechanical/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanical/cad-guidelines/">CAD Guidelines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanical/3d-printing-guidelines/">3D Printing Guidelines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanical/grabcad/">GrabCad</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">PicPilot</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../introduction/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../pid-loops/">PID Loops</a>
                </li>
                <li class="">
                    
    <a class="" href="../pwm-io/">PWM and IO</a>
                </li>
                <li class="">
                    
    <a class="" href="../uart/">UART</a>
                </li>
                <li class="">
                    
    <a class="" href="../spi/">SPI</a>
                </li>
                <li class="">
                    
    <a class="" href="../direct-memory-access/">Direct Memory Access</a>
                </li>
                <li class="">
                    
    <a class="" href="../i2c/">I2C</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Datalink</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#datalink">Datalink</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#telemetry-downlink-data">Telemetry (Downlink) Data</a></li>
        
            <li><a class="toctree-l4" href="#command-uplink-data">Command (Uplink) Data</a></li>
        
            <li><a class="toctree-l4" href="#in-the-code">In the code</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../analog-to-digital-converter/">Analog to Digital Converter</a>
                </li>
                <li class="">
                    
    <a class="" href="../sensors-and-peripherals/">Sensors and Peripherals</a>
                </li>
                <li class="">
                    
    <a class="" href="../attitude-control/">Attitude Control</a>
                </li>
                <li class="">
                    
    <a class="" href="../path-management/">Path Management</a>
                </li>
                <li class="">
                    
    <a class="" href="../resources/">Resources</a>
                </li>
                <li class="">
                    
    <a class="" href="../faq/">FAQ</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">WARG Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>PicPilot &raquo;</li>
        
      
    
    <li>Datalink</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/UWARG/edit/master/docs/picpilot/datalink.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="datalink">Datalink</h1>
<p>The datalink is one of the most important peripheral components in an unmanned
system. It provides information on the status of the aircraft (telemetry) and
provides the crucial functionality of an uplink, in order to be able to
communicate with the system and make changes to its overall functionality.</p>
<p>Make note that the details of this system can change frequently due to the
requirements of each user. The telemetry data may change from the ones present
in this document. Likewise, uplink commands may change based on newly
implemented features and requirements. Although, this document should be updated
whenever there is a change, this may not always occur. Therefore, be careful
when referencing data in this section.</p>
<h2 id="telemetry-downlink-data">Telemetry (Downlink) Data</h2>
<p>The Picpilot sends down packets based on priorities. There are 3 priorities of
packets.</p>
<ul>
<li><strong>Priority 1</strong>: <em>High frequency - multiple times a second</em></li>
<li><strong>Priority 2</strong>: <em>Medium frequency - once every second</em></li>
<li><strong>Priority 3</strong>: <em>Low frequency - have to be triggered from a relevant update</em></li>
</ul>
<p>The implementation of packets is due to the 100 byte limit that we can send data
down the Xbees. The PicPilot will send each of the three packets seperately, and
at different intervals. For Priority 3 packets, an update event will trigger
the packet to be sent down. For example, if gains were updated, a priority 3
packet will be sent back since it contains information on the gains.</p>
<h3 id="priority-1-packet-reference">Priority 1 Packet Reference</h3>
<p><em>Note</em>:</p>
<ul>
<li><code>long double</code> is 64-bit</li>
<li><code>float</code> is 32-bit</li>
<li><code>int</code> is 32-bit</li>
<li><code>char</code> is 8-bit or 1 byte</li>
</ul>
<table>
<thead>
<tr>
<th><strong>Data</strong></th>
<th><strong>Header Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Latitude</td>
<td><code>lat</code></td>
<td><code>long double</code></td>
<td>Latitude location of the airplane in degrees</td>
</tr>
<tr>
<td>Longitude</td>
<td><code>lon</code></td>
<td><code>long double</code></td>
<td>Longitude location of the airplane in degrees</td>
</tr>
<tr>
<td>Elapsed Time</td>
<td><code>sys_time</code></td>
<td><code>long int</code></td>
<td>Time elapsed since the picpilot was started in seconds</td>
</tr>
<tr>
<td>Current Time</td>
<td><code>time</code></td>
<td><code>float</code></td>
<td>The time as a UTC time stamp (seconds from Jan 1, 1970)</td>
</tr>
<tr>
<td>Pitch</td>
<td><code>pitch</code></td>
<td><code>float</code></td>
<td>Pitch of the aircraft in degrees</td>
</tr>
<tr>
<td>Roll</td>
<td><code>roll</code></td>
<td><code>float</code></td>
<td>Roll of the aircraft in degrees</td>
</tr>
<tr>
<td>Yaw</td>
<td><code>yaw</code></td>
<td><code>float</code></td>
<td>Yaw according to magnetometer on the IMU in degrees.</td>
</tr>
<tr>
<td>Pitch Rate</td>
<td><code>pitch_rate</code></td>
<td><code>float</code></td>
<td>From the gyroscope. In radians/s</td>
</tr>
<tr>
<td>Roll Rate</td>
<td><code>roll_rate</code></td>
<td><code>float</code></td>
<td>From the gyroscope. In radians/s</td>
</tr>
<tr>
<td>Yaw Rate</td>
<td><code>yaw_rate</code></td>
<td><code>float</code></td>
<td>From the gyroscope. In radians/s</td>
</tr>
<tr>
<td>Heading</td>
<td><code>heading</code></td>
<td><code>int</code></td>
<td>GPS heading of the aircraft in degrees ranging from 0 to 360.</td>
</tr>
<tr>
<td>Altitude</td>
<td><code>altitude</code></td>
<td><code>float</code></td>
<td>Altitude of the plane above the mean sea level (in meters)</td>
</tr>
<tr>
<td>Air Speed</td>
<td><code>airspeed</code></td>
<td><code>float</code></td>
<td>Current speed of the aircraft based on the airspeed sensor in m/s</td>
</tr>
<tr>
<td>Ground Speed</td>
<td><code>ground_speed</code></td>
<td><code>float</code></td>
<td>Ground speed of the aircraft in m/s</td>
</tr>
<tr>
<td>Pitch Setpoint</td>
<td><code>pitch_setpoint</code></td>
<td><code>int</code></td>
<td>Current pitch setpoint in degrees</td>
</tr>
<tr>
<td>Roll Setpoint</td>
<td><code>roll_setpoint</code></td>
<td><code>int</code></td>
<td>Current roll setpoint in degrees.</td>
</tr>
<tr>
<td>Pitch Rate Setpoint</td>
<td><code>pitch_rate_setpoint</code></td>
<td><code>int</code></td>
<td>Current pitch rate setpoint in rad/s</td>
</tr>
<tr>
<td>Roll Rate Setpoint</td>
<td><code>roll_rate_setpoint</code></td>
<td><code>int</code></td>
<td>Current roll rate setpoint in rad/s</td>
</tr>
<tr>
<td>Throttle Setpoint</td>
<td><code>throttle_setpoint</code></td>
<td><code>int</code></td>
<td>Current throttle pwm value. Ranges from -1024 to 1024, with 0 being at %50</td>
</tr>
</tbody>
</table>
<h3 id="priority-2-packet-reference">Priority 2 Packet Reference</h3>
<table>
<thead>
<tr>
<th><strong>Data</strong></th>
<th><strong>Header Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Roll KD Gain</td>
<td><code>roll_kd</code></td>
<td><code>float</code></td>
<td>Derivative gain for roll</td>
</tr>
<tr>
<td>Roll KP Gain</td>
<td><code>roll_kp</code></td>
<td><code>float</code></td>
<td>Proportional gain for roll</td>
</tr>
<tr>
<td>Pitch KD Gain</td>
<td><code>pitch_kd</code></td>
<td><code>float</code></td>
<td>Derivative gain for pitch</td>
</tr>
<tr>
<td>Pitch KP Gain</td>
<td><code>pitch_kp</code></td>
<td><code>float</code></td>
<td>Proportional gain for pitch</td>
</tr>
<tr>
<td>Yaw KP Gain</td>
<td><code>yaw_kp</code></td>
<td><code>float</code></td>
<td>Proportional gain for yaw</td>
</tr>
<tr>
<td>Yaw KD Gain</td>
<td><code>yaw_kd</code></td>
<td><code>float</code></td>
<td>Derivative gain for yaw</td>
</tr>
<tr>
<td>Yaw Rate Setpoint</td>
<td><code>yaw_rate_setpoint</code></td>
<td><code>int</code></td>
<td>Current yaw rate setpoint in rad/s</td>
</tr>
<tr>
<td>Heading Setpoint</td>
<td><code>heading_setpoint</code></td>
<td><code>int</code></td>
<td>Current heading setpoint in degrees</td>
</tr>
<tr>
<td>Altitude Setpoint</td>
<td><code>altitude_setpoint</code></td>
<td><code>int</code></td>
<td>Current altitude setpoint in m</td>
</tr>
<tr>
<td>Flap Setpoint</td>
<td><code>flap_setpoint</code></td>
<td><code>int</code></td>
<td>Current flap setpoint pwm value. Ranges from -1024 to 1024, with 0 being in middle</td>
</tr>
<tr>
<td>Last Command Sent (0)</td>
<td><code>last_command_sent0</code></td>
<td><code>int</code></td>
<td>ID of the most recent command sent</td>
</tr>
<tr>
<td>Last Command Sent (1)</td>
<td><code>last_command_sent1</code></td>
<td><code>int</code></td>
<td>ID of the most 2nd most recent command sent</td>
</tr>
<tr>
<td>Last Command Sent (2)</td>
<td><code>last_command_sent2</code></td>
<td><code>int</code></td>
<td>ID of the most 3rd most recent command sent</td>
</tr>
<tr>
<td>Last Command Sent (3)</td>
<td><code>last_command_sent3</code></td>
<td><code>int</code></td>
<td>ID of the most 4th most recent command sent</td>
</tr>
<tr>
<td>Battery 1 Level</td>
<td><code>battery_level1</code></td>
<td><code>int</code></td>
<td>PWM voltage of motor battery. Ranges from -1024 to 1024, with 1024 being full voltage</td>
</tr>
<tr>
<td>Battery 2 Level</td>
<td><code>battery_level2</code></td>
<td><code>int</code></td>
<td>PWM voltage of autopilot battery. Ranges from -1024 to 1024, with 1024 being full voltage</td>
</tr>
<tr>
<td>Camera Status</td>
<td><code>camera_status</code></td>
<td><code>int</code></td>
<td>Current number of photos taken by the camera</td>
</tr>
<tr>
<td>Wireless Connection Status</td>
<td><code>wireless_connection</code></td>
<td><code>int</code></td>
<td>Whether the plane has UHF and is in manual (full rc) or autopilot mode. Read below for bitmask guide</td>
</tr>
<tr>
<td>Autopilot Active Status</td>
<td><code>autopilot_active</code></td>
<td><code>int</code></td>
<td>Current autopilot state. ie. Initializing, Armed, etc. Read below for bitmask guide</td>
</tr>
<tr>
<td>GPS Status</td>
<td><code>gpsStatus</code></td>
<td><code>int</code></td>
<td>Indicates # of satellites connected, as well as gps fix. Check bellow for how to parse the value</td>
</tr>
<tr>
<td>Number of Waypoints</td>
<td><code>waypoint_count</code></td>
<td><code>int</code></td>
<td>Current number of waypoints</td>
</tr>
<tr>
<td>Path Following Status</td>
<td><code>path_following</code></td>
<td><code>char</code></td>
<td>Whether path following has been turned on. 1 if on</td>
</tr>
<tr>
<td>Path Checksum</td>
<td><code>path_checksum</code></td>
<td><code>float</code></td>
<td>Checksum to verify path. Calculated by adding altitude, lat, lon and radius of all waypoints</td>
</tr>
<tr>
<td>Channel 1 Input</td>
<td><code>ch1In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 2 Input</td>
<td><code>ch2In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 3 Input</td>
<td><code>ch3In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 4 Input</td>
<td><code>ch4In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 5 Input</td>
<td><code>ch5In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 6 Input</td>
<td><code>ch6In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 7 Input</td>
<td><code>ch7In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 8 Input</td>
<td><code>ch8In</code></td>
<td><code>int</code></td>
<td>Input from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 1 Output</td>
<td><code>ch1out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 2 Output</td>
<td><code>ch2out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 3 Output</td>
<td><code>ch3out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 4 Output</td>
<td><code>ch4out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 5 Output</td>
<td><code>ch5out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 6 Output</td>
<td><code>ch6out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 7 Output</td>
<td><code>ch7out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
<tr>
<td>Channel 8 Output</td>
<td><code>ch8out</code></td>
<td><code>int</code></td>
<td>Output from RC Controller. Integer value usually from -1024 to 1024, and -3072</td>
</tr>
</tbody>
</table>
<h3 id="priority-packet-3-reference">Priority Packet 3 Reference</h3>
<table>
<thead>
<tr>
<th><strong>Data</strong></th>
<th><strong>Header Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Roll KI Gain</td>
<td><code>roll_ki</code></td>
<td><code>float</code></td>
<td>Integral gain for roll</td>
</tr>
<tr>
<td>Pitch KI Gain</td>
<td><code>pitch_ki</code></td>
<td><code>float</code></td>
<td>Integral gain for pitch</td>
</tr>
<tr>
<td>Yaw KI Gain</td>
<td><code>yaw_ki</code></td>
<td><code>float</code></td>
<td>Integral gain for yaw</td>
</tr>
<tr>
<td>Heading KD Gain</td>
<td><code>heading_kd</code></td>
<td><code>float</code></td>
<td>Derivative gain for heading</td>
</tr>
<tr>
<td>Heading KI Gain</td>
<td><code>heading_ki</code></td>
<td><code>float</code></td>
<td>Integral gain for heading</td>
</tr>
<tr>
<td>Altitude KD Gain</td>
<td><code>altitude_kd</code></td>
<td><code>float</code></td>
<td>Derivative gain for altitude</td>
</tr>
<tr>
<td>Altitude KP Gain</td>
<td><code>altitude_kp</code></td>
<td><code>float</code></td>
<td>Proportional gain for altitude</td>
</tr>
<tr>
<td>Altitude KI Gain</td>
<td><code>altitude_ki</code></td>
<td><code>float</code></td>
<td>Integral gain for altitude</td>
</tr>
<tr>
<td>Throttle KD Gain</td>
<td><code>throttle_kd</code></td>
<td><code>float</code></td>
<td>Derivative gain for throttle</td>
</tr>
<tr>
<td>Throttle KI Gain</td>
<td><code>throttle_ki</code></td>
<td><code>float</code></td>
<td>Integral gain for throttle</td>
</tr>
<tr>
<td>Throttle KP Gain</td>
<td><code>throttle_kp</code></td>
<td><code>float</code></td>
<td>Proportional gain for throttle</td>
</tr>
<tr>
<td>Flap KD Gain</td>
<td><code>flap_kd</code></td>
<td><code>float</code></td>
<td>Derivative gain for flap</td>
</tr>
<tr>
<td>Flap KP Gain</td>
<td><code>flap_kp</code></td>
<td><code>float</code></td>
<td>Proportional gain for flap</td>
</tr>
<tr>
<td>Flap KI Gain</td>
<td><code>flap_ki</code></td>
<td><code>float</code></td>
<td>Integral gain for flap</td>
</tr>
<tr>
<td>Path Gain</td>
<td><code>path_gain</code></td>
<td><code>float</code></td>
<td>Proportional Path gain. How hard the aircraft adjust to follow the path</td>
</tr>
<tr>
<td>Orbital Gain</td>
<td><code>orbit_gain</code></td>
<td><code>float</code></td>
<td>Proportional Orbital gain. How hard the aircraft turn around waypoints</td>
</tr>
<tr>
<td>Autonomous Level</td>
<td><code>autonomousLevel</code></td>
<td><code>int</code></td>
<td>Autonomous level of the aircraft. Read below for how to interpret the value</td>
</tr>
<tr>
<td>Startup Error Codes</td>
<td><code>startup_error_codes</code></td>
<td><code>int</code></td>
<td>Startup error codes for the autopilot. Read below for how to interpret it</td>
</tr>
<tr>
<td>Startup Settings</td>
<td><code>startupSettings</code></td>
<td><code>int</code></td>
<td>Whether the aircraft is in plane or quad mode. Read below for bitmask guide</td>
</tr>
<tr>
<td>Probe Status</td>
<td><code>probe_status</code></td>
<td><code>int</code></td>
<td>Bitmask for determining which of the 3 probes have been released</td>
</tr>
</tbody>
</table>
<p>Note that all telemetry data must be visible within the scope of the AttitudeManager.c file.</p>
<h2 id="command-uplink-data">Command (Uplink) Data</h2>
<p>Every command that is sent to the UAV must be predefined with an ID, as well as an associated function. Some commands only change variable values, whereas some call functions with the associated data as a parameter.</p>
<table>
<thead>
<tr>
<th><strong>ID</strong></th>
<th><strong>Socket Command</strong></th>
<th><strong>Format</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>debug:<code>data</code></td>
<td>`char[]</td>
<td>The debugging command, which writes to the UART1 port.</td>
</tr>
<tr>
<td>1</td>
<td>set_pitchKDGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the derivative gain for pitch control.</td>
</tr>
<tr>
<td>2</td>
<td>set_rollKDGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the derivative gain for roll control.</td>
</tr>
<tr>
<td>3</td>
<td>set_yawKDGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the derivative gain for yaw control.</td>
</tr>
<tr>
<td>4</td>
<td>set_pitchKPGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the proportional gain for pitch control.</td>
</tr>
<tr>
<td>5</td>
<td>set_rollKPGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the proportional gain for roll control.</td>
</tr>
<tr>
<td>6</td>
<td>set_yawKPGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the proportional gain for yaw control.</td>
</tr>
<tr>
<td>7</td>
<td>set_pitchKIGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the integral gain for pitch control.</td>
</tr>
<tr>
<td>8</td>
<td>set_rollKIGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the proportional gain for roll control.</td>
</tr>
<tr>
<td>9</td>
<td>set_yawKIGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the proportional gain for yaw control.</td>
</tr>
<tr>
<td>10</td>
<td>set_headingKDGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the derivative gain for heading control.</td>
</tr>
<tr>
<td>11</td>
<td>set_headingKPGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the proportional gain for heading control.</td>
</tr>
<tr>
<td>12</td>
<td>set_headingKIGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the integral gain for heading control.</td>
</tr>
<tr>
<td>13</td>
<td>set_altitudeKDGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the derivative gain for altitude control.</td>
</tr>
<tr>
<td>14</td>
<td>set_altitudeKPGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the proportional gain for altitude control.</td>
</tr>
<tr>
<td>15</td>
<td>set_altitudeKIGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the integral gain for altitude control.</td>
</tr>
<tr>
<td>16</td>
<td>set_throttleKDGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the derivative gain for throttle control (speed).</td>
</tr>
<tr>
<td>17</td>
<td>set_throttleKPGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the derivative gain for throttle control (speed).</td>
</tr>
<tr>
<td>18</td>
<td>set_throttleKIGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command to set the integral gain for throttle control (speed).</td>
</tr>
<tr>
<td>19</td>
<td>set_pathGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command used to set the gain that scales lateral positional control around a path.</td>
</tr>
<tr>
<td>20</td>
<td>set_orbitGain:<code>data</code></td>
<td><code>float</code></td>
<td>The command used to set the gain that scales orbital convergence.</td>
</tr>
<tr>
<td>21</td>
<td>set_showGain:<code>data</code></td>
<td><code>char</code></td>
<td><strong>NOT SUPPORTED ANYMORE</strong></td>
</tr>
<tr>
<td>22</td>
<td>set_pitchRate:<code>data</code></td>
<td><code>int</code></td>
<td>The user input for the pitch rate in PWM timer tick units. (Normal values range from 470 to 941 [dependent on setup]). Note you must set command 32 greater than 4 to use this.</td>
</tr>
<tr>
<td>23</td>
<td>set_rollRate:<code>data</code></td>
<td><code>int</code></td>
<td>The user input for the roll rate in PWM timer tick units. (Normal values range from 470 to 941 [dependent on setup]) Note you must set command 32 greater than 4 to use this.</td>
</tr>
<tr>
<td>24</td>
<td>set_yawRate:<code>data</code></td>
<td><code>int</code></td>
<td>The user input for the roll rate in PWM timer tick units. (Normal values range from 470 to 941 [dependent on setup]) Note you must set command 32 greater than 4 to use this.</td>
</tr>
<tr>
<td>25</td>
<td>set_pitchAngle:<code>data</code></td>
<td><code>float</code></td>
<td>The user input for the pitch angle in degrees. Note you must set command 32 greater than 5 to use this.</td>
</tr>
<tr>
<td>26</td>
<td>set_rollAngle:<code>data</code></td>
<td><code>float</code></td>
<td>The user input for the roll angle in degrees. Note you must set command 32 greater than 5 to use this.</td>
</tr>
<tr>
<td>27</td>
<td>set_yawAngle:<code>data</code></td>
<td><code>float</code></td>
<td>The user input for the yaw angle in degrees. WILL LIKELY BE REMOVED IN THE FUTURE IF UNEEDED. Note you must set command 32 greater than 5 to use this.</td>
</tr>
<tr>
<td>28</td>
<td>set_altitude:<code>data</code></td>
<td><code>float</code></td>
<td>The user input for the altitude in meters above sea level. Note you must set command 32 greater than 6 to use this.</td>
</tr>
<tr>
<td>29</td>
<td>set_heading:<code>data</code></td>
<td><code>float</code></td>
<td>The user input for the heading in standard compass bearing degrees. Note you must set command 32 greater than 7 to use this.</td>
</tr>
<tr>
<td>30</td>
<td>set_throttle:<code>data</code></td>
<td><code>int</code></td>
<td>The user input for the throttle as a percentage. Note you must set command 32 to 8 to use this.</td>
</tr>
<tr>
<td>31</td>
<td>set_autonomousLevel:<code>data</code></td>
<td><code>int</code></td>
<td>Sets the autonomous level (full groundstation, full rc, etc.) Read below for more info</td>
</tr>
<tr>
<td>32</td>
<td>set_angularWalkVariance:<code>data</code></td>
<td><code>float</code></td>
<td>Sets the Kalman filter parameter that determines the weighting of the gryo in the attitude estimates of the plane.</td>
</tr>
<tr>
<td>34</td>
<td>set_magneticVariance:<code>data</code></td>
<td><code>float</code></td>
<td>Sets the Kalman filter parameter that determines the weighting of the magnetometers in the attitude estimates of the plane.</td>
</tr>
<tr>
<td>35</td>
<td>set_accelVariance:<code>data</code></td>
<td><code>float</code></td>
<td>Sets the Kalman filter parameter that determines the weighting of the accelerometers in the attitude estimates of the plane.</td>
</tr>
<tr>
<td>36</td>
<td>set_scaleFactor:<code>data</code></td>
<td><code>float</code></td>
<td>Sets the value for the feed-forward term of pitch, when the aircraft is turning. In other words, when the aircraft is turning, this proportion is added to the elevators to prevent the airplane from losing altitude.</td>
</tr>
<tr>
<td>37</td>
<td>calibrate_altimeter:<code>data</code></td>
<td><code>float</code></td>
<td>This sets the reference height on the altimeter to a predefined value. This allows one to choose a <em>relative</em> value for the height aircraft. For example, one may set 0m to refer to the starting or landing terrain height.</td>
</tr>
<tr>
<td>38</td>
<td>clear_waypoints:<code>data</code></td>
<td><code>byte</code></td>
<td>This command clears ALL waypoints. The <code>data</code> is just a dummy variable.</td>
</tr>
<tr>
<td>39</td>
<td>remove_waypoint:<code>data</code></td>
<td><code>byte</code></td>
<td>This command removes a specific waypoint given a specific ID as the parameter.</td>
</tr>
<tr>
<td>40</td>
<td>set_targetWaypoint:<code>data</code></td>
<td><code>byte</code></td>
<td>The target waypoint is the waypoint which the UAV is trying to currently get to. If this command is called, it can be used to skip waypoints, or return to waypoints. The <code>data</code> is the specified ID for the new target.</td>
</tr>
<tr>
<td>41</td>
<td>return_home:<code>data</code></td>
<td><code>byte</code></td>
<td>This tells the plane to go to the "home" coordinates. The <code>data</code> is just a dummy variable.</td>
</tr>
<tr>
<td>42</td>
<td>cancel_returnHome:<code>data</code></td>
<td><code>byte</code></td>
<td>This tells the plane to return back to its original path after being called to the "home" coordinates.</td>
</tr>
<tr>
<td>43</td>
<td>send_heartbeat:<code>data</code></td>
<td><code>byte</code></td>
<td>This sends a "heartbeat" (verification ping) to the plane to tell it that a data connection is still present. If this command is not received after a certain amount of time, emergency maneuvers will be used.</td>
</tr>
<tr>
<td>44</td>
<td>trigger_camera:<code>data</code></td>
<td><code>int</code></td>
<td>This manually triggers the camera via a "fake" PWM signal. The <code>data</code> is the integer value of the PWM signal.</td>
</tr>
<tr>
<td>45</td>
<td>set_triggerDistance:<code>data</code></td>
<td><code>float</code></td>
<td>This sets the trigger distance (how often a picture is taken based on distance). This <code>data</code> is a value in meters.</td>
</tr>
<tr>
<td>46</td>
<td>set_gimbleOffset:<code>data</code></td>
<td><code>int</code></td>
<td>This provides an offset to the gimbal. If the gimbal is misaligned on start up, this function can correct it.</td>
</tr>
<tr>
<td>47</td>
<td>kill_plane:<code>data</code></td>
<td><code>int</code></td>
<td>This crashes the plane into the ground (in emergencies). This requires a password (<code>data</code> = "1234") to ensure this isn't an accident.</td>
</tr>
<tr>
<td>48</td>
<td>unkill_plane:<code>data</code></td>
<td><code>int</code></td>
<td>This changes the state of the plane from "I'm crashing" to "Nevermind, this was just a test". This requires a password (<code>data</code> = "1234") to ensure this isn't an accident.</td>
</tr>
<tr>
<td>128</td>
<td>new_waypoint:<code>lon</code>,<code>lat</code>,<code>alt</code>,<code>radius</code> ,<code>type</code></td>
<td>2x<code>double</code>,2x<code>float</code>,<code>char</code></td>
<td>This uploads and appends a waypoint to the aircraft based on corresponding gps coordinates and path instructions. Type <code>1</code> for probe drop, type <code>0</code> for regular waypoint</td>
</tr>
<tr>
<td>129</td>
<td>insert_Waypoint:<code>lon</code>,<code>lat</code>,<code>alt</code>,<code>radius</code>,<code>type</code>, <code>prev_id</code>,<code>next_id</code></td>
<td>2x<code>double</code>,2x<code>float</code>,3x<code>char</code></td>
<td>This uploads and inserts a waypoint to the aircraft based on corresponding gps coordinates and path instructions.</td>
</tr>
<tr>
<td>130</td>
<td>set_ReturnHomeCoordinates:<code>lon</code>,<code>lat</code>,<code>alt</code></td>
<td>3x<code>float</code></td>
<td>This sets the home coordinates, to which the plane will return in case of an emergency.</td>
</tr>
<tr>
<td>131</td>
<td>tare_IMU:<code>data</code>,<code>data</code>,<code>data</code></td>
<td>3x<code>float</code></td>
<td>This adds a bias adjustment to the matrix based on the last setting. The 3 data values are the x,y,z components of the aircraft.</td>
</tr>
<tr>
<td>132</td>
<td>set_IMU:<code>data</code>,<code>data</code>,<code>data</code></td>
<td>3x<code>float</code></td>
<td>This is used to set the reference frame of the aircraft's IMU unit. The input values are the x,y,z values of the IMU's rotation respectively.</td>
</tr>
<tr>
<td>132</td>
<td>follow_path:<code>data</code>,<code>data</code>,<code>data</code></td>
<td>3x<code>float</code></td>
<td>This is used to set the reference frame of the aircraft's IMU unit. The input values are the x,y,z values of the IMU's rotation respectively.</td>
</tr>
<tr>
<td>132</td>
<td>drop_probe:<code>data</code>,<code>data</code>,<code>data</code></td>
<td>3x<code>float</code></td>
<td>This is used to set the reference frame of the aircraft's IMU unit. The input values are the x,y,z values of the IMU's rotation respectively.</td>
</tr>
</tbody>
</table>
<h3 id="interpretting-startup-settings">Interpretting startup settings</h3>
<h3 id="interpreting-gps">Interpreting GPS</h3>
<p>Eg. 0x00 = No GPS Fix, 0 Satellites0x1A = GPS Fix, 10 Satellites0x24 = DGPS Fix, 4 Satellites</p>
<pre><code class="javascript">var checkGPS = function (data) {
   if(data !== null) {
     var connection_status = ((data &amp; 0xf0) &gt;&gt; 4) &gt; 0; // if theres at least 1 fix
     if (connection_status !== this.gps.status) { //if its a different status
       this.gps.status = connection_status;
       StatusManager.setStatusCode('GPS_LOST', !this.gps.status);
       if (this.gps.status === false) { //if it was set to false, start the timer
         this.gps.timeSinceLost = Date.now();
       }
       else {
         this.gps.timeSinceLost = null;
       }
     }
   }
  }.bind(this);
</code></pre>

<h3 id="interpreting-autopilot_active">Interpreting autopilot_active</h3>
<pre><code class="javascript">var checkPlaneStatus = function (number) {
    if(number !== null){
      this.initializing = (number === 0);
      if (number === 1) { //only set armed to false if the number is ONLY 1
        this.armed = false;
      }
      this.armed = (number === 2);
      this.running = (number === 3);
      this.killModeWarning = (number === 4);
      this.killModeActive = (number === 5);

      StatusManager.setStatusCode('AIRCRAFT_INITIALIZE', this.initializing);
      StatusManager.setStatusCode('AIRCRAFT_UNARMED', !this.armed);
      StatusManager.setStatusCode('AIRCRAFT_ARMED', this.armed);
      StatusManager.setStatusCode('AIRCRAFT_RUNNING', this.running);
      StatusManager.setStatusCode('AIRCRAFT_KILLMODE_WARNING', this.killModeWarning);
      StatusManager.setStatusCode('AIRCRAFT_KILLMODE', this.killModeActive);
    }
  }.bind(this);
  ```
### Interpreting wireless connection
</code></pre>

<p>var checkUHFStatus = function (data) {
    if(data !== null){
      var bitmask = new Bitmask(data);
      this.uhf.status = bitmask.getBit(1);</p>
<pre><code>  if (this.uhf.status) { //has been turned to true
    this.uhf.timeSinceLost = null;
  }
  else { //has been turned to false
    this.uhf.timeSinceLost = Date.now();
  }
  StatusManager.setStatusCode('UHF_LOST', !this.uhf.status);
}
</code></pre>
<p>}.bind(this);</p>
<p>var checkManualMode = function (data) {
    if(data !== null){
      var bitmask = new Bitmask(data);
      this.manualMode = !bitmask.getBit(0);
      StatusManager.setStatusCode('MANUAL_MODE', this.manualMode);
    }
  }.bind(this);</p>
<pre><code>### Interpreting Autonotmous level
```javascript
if (alevel.getBit(0)) {
        this.ui.remote_pitch_type.text('Angle');
      }
      else {
        this.ui.remote_pitch_type.text('Rate');
      }
      if (alevel.getBit(1)) {
        this.ui.remote_pitch_source.text('Ground Station');
      }
      else {
        this.ui.remote_pitch_source.text('Controller');
      }
      if (alevel.getBit(2)) {
        this.ui.remote_roll_type.text('Angle');
      }
      else {
        this.ui.remote_roll_type.text('Rate');
      }
      if (alevel.getBit(3)) {
        this.ui.remote_roll_source.text('Ground Station');
      }
      else {
        this.ui.remote_roll_source.text('Controller');
      }
      if (alevel.getBit(5)) {
        this.ui.remote_throttle_source.text('Autopilot');
      }
      else if (alevel.getBit(4)) {
        this.ui.remote_throttle_source.text('Groundstation');
      }
      else {
        this.ui.remote_throttle_source.text('Controller');
      }
      if (alevel.getBit(6)) {
        this.ui.remote_altitude_source.text('Autopilot');
      }
      else {
        this.ui.remote_altitude_source.text('Groundstation');
      }
      if (alevel.getBit(7)) {
        this.ui.remote_altitude_toggle.text('On');
      }
      else {
        this.ui.remote_altitude_toggle.text('Off');
      }
      if (alevel.getBit(8)) {
        this.ui.remote_heading_source.text('Autopilot');
      }
      else {
        this.ui.remote_heading_source.text('Groundstation');
      }
      if (alevel.getBit(9)) {
        this.ui.remote_heading_toggle.text('On');
      }
      else {
        this.ui.remote_heading_toggle.text('Off');
      }
      if (alevel.getBit(11)) {
        this.ui.remote_flap_source.text('Autopilot');
      }
      else if (alevel.getBit(10)) {
        this.ui.remote_flap_source.text('Groundstation');
      }
      else {
        this.ui.remote_flap_source.text('Controller');
      }
    },
</code></pre>

<h3 id="interpreting-error-codes">Interpreting error codes</h3>
<p>Signals any problems that may be occurring or have occurred.This value is retrieved from StartupErrorCodes.c. The possible values are (and any binary combination):0b0000000000000000: No Errors0b0000000000000001:Power on reset occurred.0b0000000000000010:Brown out reset occurred.0b0000000000000100:Idle Mode Reset Occurred.0b0000000000001000:Sleep Mode Reset Occurred.0b0000000000010000:Software Watch Dog Timer Reset Occurred.0b0000000000100000:Software Reset Occurred.0b0000000001000000:External Reset Occurred.0b0000000010000000:Voltage Regulator Reset Occurred.0b0000000100000000:Illegal Opcode Reset Occurred.0b0000001000000000:Trap Reset Occurred.0b1000000000000000:UHF Switch is ON (Can be used to indicate joystick controller connection)</p>
<h2 id="in-the-code">In the code</h2>
<p>Prior to usage, the datalink must be initialized.  This is done so in <em>main.c _using _initDataLink()</em>. This simply initializes the UART2 interface (see UART section) for appropriate usage with the datalink.</p>
<p>After initialization, the data link can be used. The interface used to queue data to the datalink is present in the AttitudeManager.c file.</p>
<h3 id="in-the-code-downlinktelemetry">In the code – Downlink/Telemetry</h3>
<p>Data is exported to the data link at a certain frequency (according to a clock). This is done by calling <em>writeDatalink(frequency)</em>, where frequency is the time between packets. This subroutine creates a structure (defined in <em>net.h</em>) which contains memory locations for every variable. This data is then pushed to be processed in <em>net_outbound.c</em>.</p>
<pre><code>if (time - lastTime &gt; frequency) {

    lastTime = time;

    struct telem_block* statusData = createTelemetryBlock();

    statusData-&gt;lat = gps_Latitude;

    statusData-&gt;lon = gps_Longitude;

    ...

return pushOutboundTelemetryQueue(statusData);

}
</code></pre>
<p>When all the data is assembled in the struct, <em>pushOutboundTelemetryQueue(statusData)</em> is called. This pushes the data onto a queue to be processed later:</p>
<pre><code>int pushOutboundTelemetryQueue(struct telem_block *telem) {

    if (getOutboundQueueLength() &gt;= OUTBOUND_QUEUE_SIZE) {

        return -1;

    }

    outBuffer[outbuff_end] = telem;

    outbuff_end++;

    outbuff_end = outbuff_end % OUTBOUND_QUEUE_SIZE;

    return getOutboundQueueLength();

}
</code></pre>
<p>Note that this is a circular buffer. When the buffer reaches the OUTBOUND_QUEUE_SIZE, the outbuff_end variable starts from 0 and overwrites the old data.</p>
<p>Every once in a while, the data accumulated must be processed. As a result, every iteration of the program runs a subroutine to maintain and cleanup the circular buffer. For the outgoing buffer, this method is <em>outboundBufferMaintenance()</em>:</p>
<pre><code>if ( stagingBuffer.sendIndex &gt;= PACKET_LENGTH ) {

    destroyTelemetryBlock(stagingBuffer.telemetry.asStruct);

    if ( getOutboundQueueLength() ) {

        stageTelemetryBlock(popOutboundTelemetryQueue());

    }

} else if ( stagingBuffer.telemetry.asStruct == 0 &amp;&amp; getOutboundQueueLength() ) {

    stageTelemetryBlock(popOutboundTelemetryQueue());

}
</code></pre>
<p>Note that the structure of <em>stagingBuffer</em> is as follows:</p>
<pre><code>struct telem_buffer {

    unsigned int sendIndex;             // index into telemetry to send

    unsigned char header[API_HEADER_LENGTH];    // The header for the telem

    union {

        struct telem_block *asStruct;   // The telemetry block being sent

        unsigned char *asArray;         // The telemetry intepreted as an array

    } telemetry;

    unsigned char checksum;             // The checksum so far

};
</code></pre>
<p>Note that the <em>stagingBuffer _converts the data into a data link friendly format. The data link hardware requires that each data packet must be sent with a header, the data, and a checksum (For more specification see the XBEE section). These are 3 components of the _telem_buffer</em> structure. The 4th component is the <em>sendIndex</em> variable. This value is used to keep track (index) what data has already been sent or still needs to be sent.</p>
<p>After sufficient error checking (making sure <em>sendIndex</em> is less than the allowed packet size), stageTelemetryBlock(popOutboundTelemetryQueue()) is called. This method takes (pops) the next struct of data and stages it to be sent. <em>stageTelemetryBlock()</em> is responsible for converting the telemetry data into a <em>telem_buffer</em> structure.</p>
<pre><code>void stageTelemetryBlock(struct telem_block *telem) {

    stagingBuffer.telemetry.asStruct = telem;

    generateApiHeader(stagingBuffer.header, 0);

    stagingBuffer.checksum = 0;

    // Send index should be reset last for reasons

    stagingBuffer.sendIndex = 0;

    sendNextByte();

}
</code></pre>
<p>The first line of the subroutine adds the data into the packet. The second line (<em>generateApiHeader(stagingBuffer.header,0))</em> creates an appropriate header in the <em>stagingBuffer.header</em> memory address with a data frame of 0. (See the XBEE section for the datasheet). The API header includes information involving which device the packet should be sent to, the length of the packet, as well as acknowledgement options, and packet types (data packet, configuration packet, status packet). After the <em>checksum</em> and <em>sendIndex</em> are explicitly reset, the sending process begins with <em>sendNextByte()</em>:</p>
<pre><code>void sendNextByte(void) {

    unsigned char sendByte; // The byte to send

    if ( stagingBuffer.sendIndex &lt; API_HEADER_LENGTH ) {

        //while (U2STAbits.TRMT == 0);

        sendByte = stagingBuffer.header[stagingBuffer.sendIndex] &amp; 0xFF;

        // Compute checksum

        if (stagingBuffer.sendIndex &gt;= 3) {

            stagingBuffer.checksum += sendByte &amp; 0xFF;

        }

    } else if ( stagingBuffer.sendIndex &lt; PACKET_LENGTH - 1 ) {

        sendByte = stagingBuffer.telemetry.asArray[stagingBuffer.sendIndex - API_HEADER_LENGTH] &amp; 0xFF;

        stagingBuffer.checksum += sendByte &amp; 0xFF;

    } else if ( stagingBuffer.sendIndex == PACKET_LENGTH - 1) {

        sendByte = 0xFF - (stagingBuffer.checksum &amp; 0xFF);

    } else {

        IFS1bits.U2TXIF = 0;

        return;

    }

    stagingBuffer.sendIndex++;

    IFS1bits.U2TXIF = 0;

    U2TXREG = sendByte;

}
</code></pre>
<p>All the "<em>if</em>" statements above, compile the header, the data and the checksum together. Note that the checksum is the bitwise inverse of the actual sum: sendByte = 0xFF - (stagingBuffer.checksum &amp; 0xFF). The most important part of this process is the last line, where each byte is sent to the UART transmit buffer. Since the UART transmit process is interrupt-based, each interrupt keeps calling <em>sendNextByte()</em>, until there is no more data left:</p>
<pre><code>void __attribute__((__interrupt__, no_auto_psv)) _U2TXInterrupt(void) {

    // Short circuit if nothing in the staging area yet

    if ( stagingBuffer.telemetry.asStruct == 0 ) {

        IFS1bits.U2TXIF = 0;

        return;

    }

    sendNextByte();

}
</code></pre>
<p>The process can be described through this flowchart:</p>
<p><img alt="Downlink Flowchart" src="http://i.imgur.com/2pCYJRK.jpg" /></p>
<h3 id="in-the-code-uplink">In the code – Uplink</h3>
<p>Once every iteration, a command is read from the uplink queue. This is done by calling readDatalink(). The command <em>popCommand()</em> is called. If any new commands have been received, <em>popCommand()</em> will return a <em>command</em> struct (defined in <em>net.h</em>):</p>
<pre><code>struct command {

    unsigned char cmd;

    unsigned char data\_length;

    unsigned char data[101];

};
</code></pre>
<p>It is fairly straight forward. The structure contains a <em>cmd.cmd _which indicates the command ID. This ID corresponds to a certain function that needs to be completed. Following the pop command are a series of case statements (one for each command ID). For instance, if the command ID is 30, the following command is run (in _net_inbound.c</em>):</p>
<pre><code>struct command* cmd = popCommand();

//TODO: Add rudimentary input validation

if ( cmd ) {

    if (lastCommandSentCode == cmd-&gt;cmd){

        lastCommandSentCode++;

    }

    else{

        lastCommandSentCode = cmd-&gt;cmd * 100;

    }

    switch (cmd-&gt;cmd) {

        ...

        case SET_THROTTLE:

            sp_ThrottleRate = (int)(*(int*)(&amp;cmd-&gt;data) / 100.0  * (890 - 454) + 454);

            break;

        ...
    }

}
</code></pre>
<p>The throttle ends up being set to the value indicated in the <em>cmd.data</em> location. In addition, the last command read is stored and sent to the ground station as verification that the command was received.</p>
<p>The <em>popCommand() _function waits and reads the next available command from a circular buffer (note the _INBOUND_QUEUE_SIZE</em> variable). If the command doesn't exist, it exits the function.</p>
<p>In order for the command structure to exist, the <em>U2RXInterrupt</em> must have been triggered. This occurs when new data is sent.</p>
<pre><code>void __attribute__((__interrupt__, no_auto_psv)) _U2RXInterrupt(void) {

    unsigned char data = U2RXREG;

    if ( rawPacketStatus[packetPos] != BUSY ) {    // no buffer available to write

        packetPos = ( packetPos + 1  ) % RAW_PACKET_BUFFER_SIZE;

        IFS1bits.U2RXIF = 0;

        return;

    }

    switch ( payloadPos ) {

        case 0:

            if ( data != START_DELIMITER ) {

                IFS1bits.U2RXIF = 0;

                return;

            }

            break;

        case 1:

            if ( data != 0 ) {

                payloadPos = 0;

                IFS1bits.U2RXIF = 0;

                return;                 // packet length &lt; 100 bytes, so msb == 0

            }

            break;

        case 2:

            payloadLength[packetPos] = data;

            break;

        default:        // Normally, don't do anything special

            break;

    }

    rawPackets[packetPos][payloadPos++] = data;

    if ( payloadPos &amp;&amp; payloadPos == payloadLength[packetPos] + 3 + 1) {   // at end of packet

        rawPacketStatus[packetPos] = READY;

        payloadPos = 0;

        packetPos = ( packetPos + 1  ) % RAW_PACKET_BUFFER_SIZE;

        if ( rawPacketStatus[packetPos] == EMPTY ) {

            rawPacketStatus[packetPos] = BUSY;

        }

    }

    IFS1bits.U2RXIF = 0;

}
</code></pre>
<p>The first thing that occurs when new data arrives is a check to see if there is enough memory to store the data. A <em>if statement</em> is used to check if the buffer (rawPacketStatus) is busy or not.  Note that the interrupt will only record the data, if the current <em>packetPos</em> marked busy.</p>
<p>If the buffer is full, the next buffer location is checked. Otherwise, the packet is parsed byte by byte.</p>
<p>Firstly, the start delimiter is looked for using a case statement. Until the start delimiter is found, nothing happens. Secondly, for case 1 and 2, the length of the packet is check and recorded. Once the length of the packet is known, the <em>data</em> is read into a 2d array called <em>rawPackets</em>. This array contains each byte of every packet in the circular buffer. Once all the data is copied into the array, the packet is marked as <em>READY</em>, and the next one is marked <em>BUSY</em> if it is <em>EMPTY</em>, and the processing of the data begins on the next maintenance cycle when <em>inboundBufferMaintenance()</em> is called from <em>main.c</em>:</p>
<pre><code>void inboundBufferMaintenance(void) {

    int i;

    for ( i = 0; i &lt; RAW_PACKET_BUFFER_SIZE; i++ ) {

        if ( rawPacketStatus[i] == READY &amp;&amp; checkPacket(rawPackets[i]) ) {

            struct command\* cmd = createCommand( rawPackets[i] );

            if ( cmd ) {            // create command was successful ?

                pushCommand( cmd ); // queue it up

                rawPacketStatus[i] = EMPTY;         // buffer is now good for writing another packet

            }

        }

    }

    if ( rawPacketStatus[0] == EMPTY ) {

        rawPacketStatus[0] = BUSY;

    }

}
</code></pre>
<p>This subroutine iterates through each buffer location and checks for any <em>READY</em> packets. If one is found, and it has been verified through a checksum, the command structure is created from the data using the <em>createCommand(rawPackets[i])</em> method. Once this is done, the previous spot is marked <em>EMPTY</em>. The first buffer is always primed if it is empty.</p>
<p><img alt="Uplink Flowchart" src="http://i.imgur.com/F71doku.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../analog-to-digital-converter/" class="btn btn-neutral float-right" title="Analog to Digital Converter">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../i2c/" class="btn btn-neutral" title="I2C"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright <a href="http://www.uwarg.com"> University of Waterloo Aerial Robotics Group</a></p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/UWARG/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../i2c/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../analog-to-digital-converter/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>
      <script src="../../sloth-generator.js"></script>

</body>
</html>
