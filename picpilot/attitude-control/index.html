<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="University of Waterloo Aerial Robotics Group">
  <link rel="shortcut icon" href="../../favicon.ico">
  
  <title>Attitude Control - WARG Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Attitude Control";
    var mkdocs_page_input_path = "picpilot/attitude-control.md";
    var mkdocs_page_url = "/picpilot/attitude-control/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68186801-2', 'docs.uwarg.com');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> WARG Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Bootcamps</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../bootcamp/mechanical/">Mechanical</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/computer-vision/">Computer Vision</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/electrical/">Electrical</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/groundstation/">Groundstation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/embedded/">Embedded Software</a>
                </li>
                <li class="">
                    
    <a class="" href="../../bootcamp/rccompetition/">RC Car Competition</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tutorials</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../tutorials/git/">Git and Github</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tutorials/shell/">Using the terminal</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Groundstation</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../groundstation/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/introduction/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/what-you-need-to-know/">What you need to know</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/installation/">Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/tutorial/">Tutorial</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/project-structure/">Project Structure</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/contributing/">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/documenting/">Documenting</a>
                </li>
                <li class="">
                    
    <a class="" href="../../groundstation/resources/">Additional Resources</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">ZeroPilot</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../zeropilot/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../zeropilot/pinout_reference/">Pinout Reference</a>
                </li>
                <li class="">
                    
    <a class="" href="../../zeropilot/hardware/">Hardware</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Network</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../network/data_relay/">Data Relay</a>
                </li>
                <li class="">
                    
    <a class="" href="../../network/multi_echo/">Multi Echo</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Computer Vision</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../computer-vision/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Installation/">Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Building-the-project-[Linux]/">Building the project [Linux]</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Building-the-project-[Windows]/">Building the project [Windows]</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Coding-Conventions/">Coding Conventions</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Contributing/">Contributing</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Using-the-WARG-server-environment/">Using the WARG computer environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../../computer-vision/Writing-Tests/">Writing Tests</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Mechanical</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../mechanical/">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanical/cad-guidelines/">CAD Guidelines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanical/3d-printing-guidelines/">3D Printing Guidelines</a>
                </li>
                <li class="">
                    
    <a class="" href="../../mechanical/grabcad/">GrabCad</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">PicPilot</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../">Table of Contents</a>
                </li>
                <li class="">
                    
    <a class="" href="../introduction/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../pid-loops/">PID Loops</a>
                </li>
                <li class="">
                    
    <a class="" href="../pwm-io/">PWM and IO</a>
                </li>
                <li class="">
                    
    <a class="" href="../uart/">UART</a>
                </li>
                <li class="">
                    
    <a class="" href="../spi/">SPI</a>
                </li>
                <li class="">
                    
    <a class="" href="../direct-memory-access/">Direct Memory Access</a>
                </li>
                <li class="">
                    
    <a class="" href="../i2c/">I2C</a>
                </li>
                <li class="">
                    
    <a class="" href="../datalink/">Datalink</a>
                </li>
                <li class="">
                    
    <a class="" href="../analog-to-digital-converter/">Analog to Digital Converter</a>
                </li>
                <li class="">
                    
    <a class="" href="../sensors-and-peripherals/">Sensors and Peripherals</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Attitude Control</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#attitude-control">Attitude Control</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#initialization">Initialization</a></li>
        
            <li><a class="toctree-l4" href="#aggregation-of-data">Aggregation of Data</a></li>
        
            <li><a class="toctree-l4" href="#error-analysis-pid-control">Error Analysis (PID control)</a></li>
        
            <li><a class="toctree-l4" href="#output-corrections">Output Corrections</a></li>
        
            <li><a class="toctree-l4" href="#control-levels">Control Levels</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../path-management/">Path Management</a>
                </li>
                <li class="">
                    
    <a class="" href="../resources/">Resources</a>
                </li>
                <li class="">
                    
    <a class="" href="../faq/">FAQ</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">WARG Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>PicPilot &raquo;</li>
        
      
    
    <li>Attitude Control</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/UWARG/edit/master/docs/picpilot/attitude-control.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="attitude-control">Attitude Control</h1>
<p>Attitude Control is very similar regardless of the aircraft which is being used. The end goal is to be able to keep the aircraft stable and in control. The way in which this is achieved is always very similar.</p>
<p>In the PICpilot, we use PID loops to manage our system. Although there are other types of controllers available, PID controllers are the best option due to their reliability, accuracy, and simplicity. The section on PID loops has a detailed explanation of how they work, and how they work together.</p>
<p>This section mostly deals with the <em>AttitudeManager.c</em> file, as the name implies.</p>
<p>The attitude manager has the 3 main goals, as well as a side task. The 3 main goals include the aggregation of status data (inputs, sensors, etc.), error analysis on the status of the aircraft, and corrections to the aircraft. The side task involves sending all this data to the ground station, as well as receiving from the ground station.</p>
<h2 id="initialization">Initialization</h2>
<p>The initialization process involves beginning communication with all components. The process involves the following steps:</p>
<ol>
<li>Initializing communication to the Path Manager via SPI and DMA</li>
<li>VN 100 is initialized</li>
<li>VN 100 is offset according to a rotation matrix</li>
<li>VN 100 is then calibrated with confidence parameters for the X/Y/Z magnetometers, accelerometers, and gyroscopes</li>
<li>PWM input and output is specified according to the used channels</li>
</ol>
<p>This can be found in the <em>attitudeInit()</em> function in the <em>AttitudeManager.c</em> file.</p>
<h2 id="aggregation-of-data">Aggregation of Data</h2>
<p>Using the initialized sensors from the prior section, the vehicle can now collect data systematically.</p>
<p>Every loop, new data is acquired from the DMA/SPI interface connected to the Path Manager chip. Data acquired from this chip includes the time, heading, speed, longitude, latitude, altitude, number of satellites, position fix, battery level, waypoint index, set point altitude, and set point heading.</p>
<p>Next, data is acquired from the PWM inputs. This includes stick positions, which determine the roll, pitch, yaw, and throttle of the aircraft. These inputs are scaled to values ranging from -1024 to 1024.</p>
<p>Finally, the VectorNav is polled for the latest rotational data. The roll, pitch, and yaw rate data is acquired through the <em>VN100_SPI_GetRates(0, (float*) &amp;imuData)</em> function call. The roll, pitch, and yaw angles can be determined via the <em>VN100_SPI_GetYPR(0, &amp;imuData[YAW], &amp;imuData[PITCH], &amp;imuData[ROLL])</em> function call.</p>
<p>This concludes all data acquisition. The next step involves analyzing the error.</p>
<h2 id="error-analysis-pid-control">Error Analysis (PID control)</h2>
<p>PID control works on the basis of minimizing error. The majority of the attitude manager involves consecutive PID loops correcting specific portions of flying an aircraft.</p>
<p>All the PID loop code can be found in the <em>OrientationControl.c</em> file. It is called from the AttitudeManager.c code.</p>
<h3 id="altitude">Altitude</h3>
<p>The altitude is controlled through a standard PID loop. This can be found in the code:</p>
<pre><code>    sp_PitchAngle = controlSignalAltitude(sp_Altitude,(int)gps_Altitude);

    if (sp_PitchAngle &gt; MAX_PITCH_ANGLE)

        sp_PitchAngle = MAX_PITCH_ANGLE;

    if (sp_PitchAngle &lt; -MAX_PITCH_ANGLE)

        sp_PitchAngle = -MAX_PITCH_ANGLE;
</code></pre>
<p>Logically, the pitch angle is determined from the desired altitude. If the plane is too low, the pitch angle will be positive (up). If the plane is too high, the pitch angle will be negative (down). The pitch angle is then checked to be within "safety limits".</p>
<h3 id="throttle">Throttle</h3>
<p>Like the altitude PID loop, the throttle also has PID loop, which is also based on the altitude:</p>
<pre><code>    control_Throttle = sp_ThrottleRate + controlSignalThrottle(sp_Altitude, (int)gps_Altitude);

    if (control_Throttle &gt; MAX_PWM){

        control_Throttle = MAX_PWM;

    }

    else if (control_Throttle &lt; MIN_PWM){

        control_Throttle = MIN_PWM;

    }
</code></pre>
<p>Logically, if the plane needs to climb, you need to increase the throttle (otherwise it will stall due to low airspeed). Likewise, if the plane needs to reduce its altitude, to prevent high airspeeds, the plane decreases the throttle. If the plane is perfectly positioned, a constant throttle is maintained as per the <em>sp_ThrottleRate</em> variable. Once again, the throttle is limited within the legal limits of the throttle (to ensure the throttle doesn't become negative or larger than 100%).</p>
<h3 id="heading">Heading</h3>
<p>The heading control code looks as such:</p>
<pre><code>    while (sp_Heading &gt; 360)

        sp_Heading -=360;

    while (sp_Heading &lt; 0)

        sp_Heading +=360;

        sp_HeadingRate = controlSignalHeading(sp_Heading, gps_PositionFix==2?gps_Heading:(int)imu_YawAngle);

        //Approximating Roll angle from Heading

        sp_RollAngle = sp_HeadingRate;//(int)(atan((float)(sp_HeadingRate)) * PI/180.0);

    if (sp_RollAngle &gt; MAX_ROLL_ANGLE)

        sp_RollAngle = MAX_ROLL_ANGLE;

    if (sp_RollAngle &lt; -MAX_ROLL_ANGLE)

        sp_RollAngle = -MAX_ROLL_ANGLE;
</code></pre>
<p>As you can see, the input is the heading and the resulting output is a roll angle. In other words, if there is a greater error in the heading, a larger roll angle is established to correct for the heading error.</p>
<p>The first two while loops take into account any angle overflow or underflow, in other words, if the value is above 360 or negative, it is scaled to be between 0 and 360.</p>
<p>Once again the roll value is limited to a reasonable value, to prevent excessive maneuvers.</p>
<h3 id="angles">Angles</h3>
<p>The code to maintain the angular roll and pitch of the aircraft look as such (one statement for each):</p>
<pre><code>sp_ComputedRollRate = controlSignalAngles(sp_RollAngle,  imu_RollAngle, ROLL, -(SP_RANGE) / (MAX_ROLL_ANGLE));
</code></pre>
<p>Note that depending on the on the input angles, the output is a "rate". It is an angular rate. In other words, if the difference between the setpoint and the output is large, the angular rate will also be large.</p>
<h3 id="angular-rate">Angular Rate</h3>
<p>The result from the angular PID loop gives rise to the angular rate PID loop. This loop is often acknowledged as a stabilizing system, where small quick vibrations are accounted for.</p>
<pre><code>control_Roll = controlSignal((sp_ComputedRollRate / SERVO_SCALE_FACTOR), imu_RollRate, ROLL);
</code></pre>
<p>The output of this function completes the PID pipeline. The value of <em>control_Roll</em>, or the equivalent variable for the pitch for that matter, is then directly applied to the PWM module, in order to create a correction to the system (using the flaps, elevators, rudder, or what not).</p>
<h2 id="output-corrections">Output Corrections</h2>
<p>Once the calculations have been made to determine what corrections should be made to the system, it is then time to physically alter the system based on the calculations.</p>
<p>This involves output to the PWM module. After a series of checks, to ensure that all values are within the maximum and minimum parameters for the PWM signal, a PWM call is made to the appropriate channel:</p>
<pre><code>setPWM(1, control_Roll + rollTrim);
</code></pre>
<p>As long as the PWM module was initialized, there shouldn't be any problem. The vehicle should move its servos appropriately.</p>
<h2 id="control-levels">Control Levels</h2>
<p>The control levels implemented in the attitude manager are an important part of the testing process. These levels determine which input sources have primary control over the aircraft, as well as how the input translates into flight.</p>
<p>For instance, when testing, one may wish to have control of the throttle, while the roll and pitch is controlled by the autopilot. Such control is implemented in the code.</p>
<p>As it is evident above, there a separate sections of code, which control individual PID loops. The control levels change the source of the input to the PIDs using a simple bit mask. The control level is actually determined by a single integer. Each value of the integer represents a different <em>control level.</em> As a result, a bit mask is placed within an, if statement to determine whether or not a specific element of control is enabled or disabled.</p>
<p>For instance, take this scenario:</p>
<pre><code>if ((controlLevel &amp; ROLL_CONTROL_SOURCE) == 0 &amp;&amp; (controlLevel &amp; HEADING_CONTROL_ON) == 0)

    sp_RollAngle = (int)((-sp_RollRate / ((float)SP\_RANGE / MAX_ROLL_ANGLE) ));
</code></pre>
<p>This snippet of code, converts the controller input into a roll angle. For instance, if the stick is centered, the plane will be at a 0° roll angle. If the pilot steers left, the plane will angle itself left at that same angle. The <em>if</em> statement contains two bit masks. Note that the <em>controlLevel</em> variable has a <em>bitwise AND </em>(&amp;) applied to it.</p>
<p>Therefore, if the controlLevel is (in binary):</p>
<p>0b00000000 00010011</p>
<p>The code above will run, because a <em>AND</em> bit mask of 0b00001000, will return a value of zero, just as well as 0b00000010 00000000 will also return a logical value of zero.</p>
<p>This type of logic is applied to multiple sections of the attitude manager code.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../path-management/" class="btn btn-neutral float-right" title="Path Management">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../sensors-and-peripherals/" class="btn btn-neutral" title="Sensors and Peripherals"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright <a href="http://www.uwarg.com"> University of Waterloo Aerial Robotics Group</a></p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/UWARG/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../sensors-and-peripherals/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../path-management/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>
      <script src="../../sloth-generator.js"></script>

</body>
</html>
